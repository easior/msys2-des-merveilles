# Maintainer : Lars EASIOR <easior(dot)lars(at)gmail(dot)com>

_realname=amule
pkgbase="mingw-w64-${_realname}"
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=2.3.3
pkgrel=3
pkgdesc="Client for the eD2k and Kad networks"
url="https://amule.org/"
license=('GPL2')
arch=('x86_64')
depends=("${MINGW_PACKAGE_PREFIX}-crypto++" "${MINGW_PACKAGE_PREFIX}-geoip" "${MINGW_PACKAGE_PREFIX}-libpng" "${MINGW_PACKAGE_PREFIX}-pupnp" "${MINGW_PACKAGE_PREFIX}-wxwidgets3.2-msw" "${MINGW_PACKAGE_PREFIX}-libgd")
makedepends=("${MINGW_PACKAGE_PREFIX}-boost" "${MINGW_PACKAGE_PREFIX}-cmake")
provides=("${MINGW_PACKAGE_PREFIX}-amule")
#conflicts=(amule)
source=(https://github.com/amule-project/amule/archive/refs/tags/$pkgver.tar.gz)
        #"git+https://github.com/amule-project/amule.git"
        #git+https://repo.or.cz/amule.git)
sha256sums=('SKIP')

#pkgver() {
#  cd amule
#  git describe --tags | sed 's/-/.r/; s/-g/./'
#}

build() {
  cd "${srcdir}/${_realname}-${pkgver}"
  cmake -B build \
    -DCMAKE_INSTALL_PREFIX=${MINGW_PREFIX}/ \
    -DBUILD_ALC=ON \
    -DBUILD_ALCC=ON \
    -DBUILD_AMULECMD=ON \
    -DBUILD_CAS=ON \
    -DBUILD_DAEMON=ON \
    -DBUILD_REMOTEGUI=ON \
    -DBUILD_WEBSERVER=ON \
    -DBUILD_WXCAS=ON \
    -DBUILD_FILEVIEW=ON \
    -DENABLE_NLS=ON
  cmake --build build
}

check() {
  make -C build test
}

package() {
  DESTDIR="$pkgdir" cmake --install build
#  install -Dm644 "$srcdir"/amuled.systemd "$pkgdir"/usr/lib/systemd/system/amuled.service
#  install -Dm644 "$srcdir"/amuleweb.systemd "$pkgdir"/usr/lib/systemd/system/amuleweb.service
#  install -Dm644 "$srcdir"/amule.sysusers "$pkgdir"/usr/lib/sysusers.d/amule.conf
#  install -Dm644 "$srcdir"/amule.tmpfiles "$pkgdir"/usr/lib/tmpfiles.d/amule.conf
}
